<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Trades â€“ Reno Robs Trading</title>
    <link rel="icon" type="image/png" href="/static/logo.png">

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
            background-color: #f7f9fc;
            color: #1f2937;
        }

        .navbar {
            background: white;
            padding: 18px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .navbar h2 { margin: 0; font-weight: 600; }

        .nav-links a {
            margin-left: 20px;
            text-decoration: none;
            font-weight: 500;
            color: #4f46e5;
        }

        .logout { color: #dc2626; }

        .container {
            padding: 40px;
            max-width: 1300px;
            margin: auto;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.05);
        }

        .card h3 {
            margin: 0;
            font-size: 14px;
            color: #6b7280;
        }

        .card p {
            font-size: 28px;
            font-weight: 600;
            margin-top: 8px;
            margin-bottom: 0;
        }

        .positive { color: #16a34a; }
        .negative { color: #dc2626; }
        .neutral  { color: #1f2937; }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 14px rgba(0,0,0,0.05);
            margin-bottom: 40px;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
        }

        th {
            background: #f3f4f6;
            font-weight: 600;
        }

        tr:not(:last-child) {
            border-bottom: 1px solid #f1f1f1;
        }

        .good { color: #16a34a; font-weight: 600; }
        .bad  { color: #dc2626; font-weight: 600; }

        .sell-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
        }

        .sell-btn:hover { background: #b91c1c; }

        .empty-note {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.05);
            color: #6b7280;
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        /* ---- Mobile ---- */
        @media (max-width: 640px) {
            /* Navbar */
            .navbar { padding: 10px 14px; flex-wrap: wrap; gap: 6px; }
            .navbar h2 { font-size: 14px; }
            .nav-user { display: none; }
            .nav-links { display: flex; flex-wrap: wrap; gap: 4px; width: 100%; }
            .nav-links a { margin-left: 0; padding: 5px 10px; font-size: 12px;
                           background: #f3f4f6; border-radius: 5px; }
            .nav-links .logout { background: #fee2e2; }

            /* Layout */
            .container { padding: 14px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
            .card { padding: 16px; }
            .card p { font-size: 20px; }

            /* Tables */
            table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            th, td { padding: 9px 10px; font-size: 12px; white-space: nowrap; }
            .hide-mobile { display: none; }

            /* Sticky symbol column â€” inherit row bg so green rows stay green */
            th:first-child, td:first-child {
                position: sticky; left: 0; z-index: 1;
                background: inherit; box-shadow: 2px 0 4px rgba(0,0,0,0.06);
            }
            thead th:first-child { background: #f3f4f6; }

            /* Bigger action buttons */
            .sell-btn { min-height: 40px; padding: 10px 14px; font-size: 14px; }
        }
    </style>
</head>

<body>

<div class="navbar">
    <div style="display:flex; align-items:center; gap:12px;">
        <img src="/static/logo.png" alt="Logo" style="height:44px; width:auto; border-radius:6px;">
        <h2 style="margin:0;">Reno Robs Trading</h2>
    </div>

    <div class="nav-links">
        <span class="nav-user" style="margin-right:20px; color:#6b7280;">
            Logged in as {{ user }}
        </span>
        <a href="/dashboard">Dashboard</a>
        <a href="/analytics">Analytics</a>
        <a href="/trades">Trades</a>
        <a href="/validation">Validation</a>
        <a href="/account">Account</a>
        <a href="/logout" class="logout">Logout</a>
    </div>
</div>

<div class="container">

    <h2 style="margin-bottom:30px;">Paper Trading</h2>

    <!-- PORTFOLIO SUMMARY -->
    <div class="kpi-grid">

        <div class="card">
            <h3>Cash Balance</h3>
            <p class="neutral">${{ "{:,.2f}".format(summary.cash) }}</p>
        </div>

        <div class="card">
            <h3>Open Positions Value</h3>
            <p class="neutral">${{ "{:,.2f}".format(summary.open_value) }}</p>
        </div>

        <div class="card">
            <h3>Total Portfolio Value</h3>
            <p class="neutral">${{ "{:,.2f}".format(summary.total_value) }}</p>
        </div>

        <div class="card">
            <h3>Total P&amp;L</h3>
            <p class="{{ 'positive' if summary.total_pnl >= 0 else 'negative' }}">
                {{ "+" if summary.total_pnl >= 0 else "" }}${{ "{:,.2f}".format(summary.total_pnl) }}
            </p>
        </div>

    </div>

    <!-- AUTO-CLOSE NOTIFICATIONS -->
    {% if auto_closed %}
    <div style="background:#f0fdf4; border:1px solid #86efac; border-radius:10px;
                padding:16px 20px; margin-bottom:24px;">
        <div style="font-weight:700; color:#15803d; margin-bottom:8px;">
            ðŸŽ¯ Target Hit â€” Position{{ 's' if auto_closed|length > 1 else '' }} Auto-Sold at +20%
        </div>
        {% for t in auto_closed %}
        <div style="font-size:14px; color:#166534;">
            <strong>{{ t.symbol }}</strong> sold at ${{ t.exit_price }} &nbsp;Â·&nbsp;
            P&amp;L: <strong>+${{ "{:,.2f}".format(t.realized_pnl) }}</strong>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- OPEN POSITIONS -->
    <div style="display:flex; align-items:baseline; justify-content:space-between; margin-bottom:16px;">
        <div class="section-title" style="margin-bottom:0;">Open Positions</div>
        <span id="lastRefresh" style="font-size:12px; color:#9ca3af;">Live â€” refreshes every 60s</span>
    </div>

    {% if positions %}
    <table>
        <thead>
            <tr>
                <th>Symbol</th>
                <th class="hide-mobile">Entry Price</th>
                <th class="hide-mobile">Target</th>
                <th>Current Price</th>
                <th>To Target</th>
                <th class="hide-mobile">Shares</th>
                <th class="hide-mobile">Current Value</th>
                <th class="hide-mobile">Unrealized P&amp;L</th>
                <th>P&amp;L %</th>
                <th class="hide-mobile">Opened</th>
                <th class="hide-mobile">Notes</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        {% for pos in positions %}
            <tr style="{{ 'background:#f0fdf4;' if pos.to_target_pct <= 0 else '' }}">
                <td><strong>{{ pos.symbol }}</strong></td>
                <td class="hide-mobile">${{ pos.entry_price }}</td>
                <td class="hide-mobile" style="color:#0f766e; font-weight:600;">
                    ${{ pos.target_price }}
                    <span style="font-size:11px; color:#6b7280; font-weight:400;">(+{{ pos.take_profit_pct|int }}%)</span>
                </td>
                <td id="price-{{ pos.trade_id }}">${{ pos.current_price }}</td>
                <td id="totarget-{{ pos.trade_id }}" style="font-size:13px; color:{{ '#16a34a' if pos.to_target_pct <= 5 else '#6b7280' }};">
                    {% if pos.to_target_pct <= 0 %}ðŸŽ¯ At target{% else %}+{{ pos.to_target_pct }}% away{% endif %}
                </td>
                <td class="hide-mobile">{{ pos.shares | round(2) }}</td>
                <td class="hide-mobile" id="value-{{ pos.trade_id }}">${{ "{:,.2f}".format(pos.current_value) }}</td>
                <td class="hide-mobile {{ 'good' if pos.unrealized_pnl >= 0 else 'bad' }}" id="upnl-{{ pos.trade_id }}">
                    {{ "+" if pos.unrealized_pnl >= 0 else "" }}${{ "{:,.2f}".format(pos.unrealized_pnl) }}
                </td>
                <td id="pnlpct-{{ pos.trade_id }}" class="{{ 'good' if pos.pnl_pct >= 0 else 'bad' }}">
                    {{ "+" if pos.pnl_pct >= 0 else "" }}{{ pos.pnl_pct }}%
                </td>
                <td class="hide-mobile" style="font-size:12px; color:#6b7280;">
                    {{ pos.opened_at[:16].replace("T", " ") }}
                </td>
                <td class="hide-mobile" style="font-size:12px; color:#4b5563; max-width:160px;">
                    {{ pos.notes if pos.notes else "â€”" }}
                </td>
                <td>
                    <form method="post" action="/trade/sell/{{ pos.trade_id }}">
                        {% if pos.to_target_pct <= 0 %}
                        <button type="submit" class="sell-btn"
                                style="background:#0f766e; font-weight:600;">
                            ðŸŽ¯ Take Profit
                        </button>
                        {% else %}
                        <button type="submit" class="sell-btn">Sell</button>
                        {% endif %}
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-note">No open positions. Buy a stock from the Dashboard to get started.</div>
    {% endif %}

    <!-- TRADE HISTORY -->
    <div class="section-title">Trade History</div>

    {% if history %}
    <table>
        <thead>
            <tr>
                <th>Symbol</th>
                <th class="hide-mobile">Entry Price</th>
                <th>Exit Price</th>
                <th class="hide-mobile">Shares</th>
                <th>Realized P&amp;L</th>
                <th>P&amp;L %</th>
                <th class="hide-mobile">Opened</th>
                <th>Closed</th>
                <th class="hide-mobile">Notes</th>
                <th>Outcome</th>
            </tr>
        </thead>
        <tbody>
        {% for trade in history %}
            <tr>
                <td><strong>{{ trade.symbol }}</strong></td>
                <td class="hide-mobile">${{ trade.entry_price }}</td>
                <td>${{ trade.exit_price }}</td>
                <td class="hide-mobile">{{ trade.shares }}</td>
                <td class="{{ 'good' if trade.realized_pnl >= 0 else 'bad' }}">
                    {{ "+" if trade.realized_pnl >= 0 else "" }}${{ "{:,.2f}".format(trade.realized_pnl) }}
                </td>
                <td class="{{ 'good' if trade.pnl_pct >= 0 else 'bad' }}">
                    {{ "+" if trade.pnl_pct >= 0 else "" }}{{ trade.pnl_pct }}%
                </td>
                <td class="hide-mobile" style="font-size:12px; color:#6b7280;">
                    {{ trade.opened_at[:16].replace("T", " ") }}
                </td>
                <td style="font-size:12px; color:#6b7280;">
                    {{ trade.closed_at[:16].replace("T", " ") }}
                </td>
                <td class="hide-mobile" style="font-size:12px; color:#4b5563; max-width:160px;">
                    {{ trade.notes if trade.notes else "â€”" }}
                </td>
                <td style="white-space:nowrap;">
                    <form method="post" action="/trade/{{ trade.trade_id }}/tag" style="display:inline;">
                        <input type="hidden" name="outcome_tag" value="win">
                        <button type="submit" style="padding:2px 8px; font-size:11px; border-radius:4px; cursor:pointer;
                            background:{{ '#0f766e' if trade.outcome_tag == 'win' else 'transparent' }};
                            color:{{ '#fff' if trade.outcome_tag == 'win' else '#0f766e' }};
                            border:1px solid #0f766e;">âœ“</button>
                    </form>
                    <form method="post" action="/trade/{{ trade.trade_id }}/tag" style="display:inline;">
                        <input type="hidden" name="outcome_tag" value="loss">
                        <button type="submit" style="padding:2px 8px; font-size:11px; border-radius:4px; cursor:pointer;
                            background:{{ '#dc2626' if trade.outcome_tag == 'loss' else 'transparent' }};
                            color:{{ '#fff' if trade.outcome_tag == 'loss' else '#dc2626' }};
                            border:1px solid #dc2626;">âœ—</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-note">No closed trades yet.</div>
    {% endif %}

    <!-- WATCHLIST -->
    <div class="section-title">Watchlist</div>

    {% if watchlist %}
    <table>
        <thead>
            <tr>
                <th>Symbol</th>
                <th class="hide-mobile">Price When Added</th>
                <th>Current Price</th>
                <th>Change</th>
                <th class="hide-mobile">Added</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        {% for w in watchlist %}
            <tr>
                <td><strong>{{ w.symbol }}</strong></td>
                <td class="hide-mobile">${{ "{:.4f}".format(w.price_at_add) if w.price_at_add else "â€”" }}</td>
                <td id="wl-price-{{ w.symbol }}">â€”</td>
                <td id="wl-chg-{{ w.symbol }}" style="font-size:13px;">â€”</td>
                <td class="hide-mobile" style="font-size:12px; color:#6b7280;">{{ w.added_at[:10] }}</td>
                <td>
                    <form method="post" action="/watchlist/remove/{{ w.symbol }}" style="display:inline;">
                        <button type="submit" class="sell-btn"
                                style="background:#6b7280; font-size:12px;">
                            Remove
                        </button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-note">
        No stocks on your watchlist. Click "Watch" on any stock in the Dashboard to track it.
    </div>
    {% endif %}

</div>

<script>
// ---- Live price refresh for open positions (every 60s) ----
async function refreshPositionPrices() {
    try {
        const resp = await fetch('/api/positions/prices');
        if (!resp.ok) return;
        const data = await resp.json();
        for (const [id, d] of Object.entries(data)) {
            const priceEl   = document.getElementById('price-'   + id);
            const targetEl  = document.getElementById('totarget-'+ id);
            const valueEl   = document.getElementById('value-'   + id);
            const upnlEl    = document.getElementById('upnl-'    + id);
            const pnlPctEl  = document.getElementById('pnlpct-'  + id);
            if (priceEl)  priceEl.textContent  = '$' + d.current_price;
            if (valueEl)  valueEl.textContent  = '$' + d.current_value.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
            if (upnlEl) {
                upnlEl.textContent = (d.unrealized_pnl >= 0 ? '+' : '') + '$' + Math.abs(d.unrealized_pnl).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});
                upnlEl.className = d.unrealized_pnl >= 0 ? 'good' : 'bad';
            }
            if (pnlPctEl) {
                pnlPctEl.textContent = (d.pnl_pct >= 0 ? '+' : '') + d.pnl_pct + '%';
                pnlPctEl.className = d.pnl_pct >= 0 ? 'good' : 'bad';
            }
            if (targetEl) {
                if (d.to_target_pct <= 0) {
                    targetEl.textContent = 'ðŸŽ¯ At target';
                    targetEl.style.color = '#16a34a';
                } else {
                    targetEl.textContent = '+' + d.to_target_pct + '% away';
                    targetEl.style.color = d.to_target_pct <= 5 ? '#16a34a' : '#6b7280';
                }
            }
        }
        document.getElementById('lastRefresh').textContent = 'Updated ' + new Date().toLocaleTimeString();
    } catch(e) {}
}

setInterval(refreshPositionPrices, 60000);
</script>

</body>
</html>
