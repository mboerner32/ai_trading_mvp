<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Data Validation – Reno Robs Trading</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
            background-color: #f7f9fc;
            color: #1f2937;
        }
        .navbar {
            background: white;
            padding: 18px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .navbar h2 { margin: 0; font-weight: 600; }
        .nav-links a {
            margin-left: 20px;
            text-decoration: none;
            font-weight: 500;
            color: #374151;
        }
        .nav-links a:hover { color: #1d4ed8; }
        .container { max-width: 1100px; margin: 32px auto; padding: 0 24px; }

        .header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .header-row h1 { margin: 0; font-size: 22px; font-weight: 700; }

        .run-btn {
            background: #1d4ed8;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .run-btn:hover { background: #1e40af; }

        .info-banner {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 13px;
            color: #1e40af;
            margin-bottom: 24px;
        }

        .running-banner {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 13px;
            color: #92400e;
            margin-bottom: 24px;
        }

        .no-reports {
            text-align: center;
            padding: 48px 24px;
            color: #9ca3af;
            font-size: 15px;
        }

        /* Report card */
        .report-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.07);
            margin-bottom: 24px;
            overflow: hidden;
        }
        .report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            flex-wrap: wrap;
            gap: 8px;
        }
        .report-time {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }
        .report-summary {
            display: flex;
            gap: 12px;
            font-size: 13px;
        }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 12px;
        }
        .badge-ok   { background: #d1fae5; color: #065f46; }
        .badge-warn { background: #fef3c7; color: #92400e; }
        .badge-err  { background: #fee2e2; color: #991b1b; }

        /* Symbol rows inside a report */
        .symbol-table { width: 100%; border-collapse: collapse; }
        .symbol-table th {
            text-align: left;
            padding: 9px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: .04em;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        .symbol-table td {
            padding: 10px 16px;
            font-size: 13px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }
        .symbol-table tr:last-child td { border-bottom: none; }
        .symbol-table tr:hover td { background: #f9fafb; }

        .status-ok   { color: #065f46; font-weight: 600; }
        .status-warn { color: #b45309; font-weight: 600; }
        .status-err  { color: #991b1b; font-weight: 600; }

        /* Metric chips inside a cell */
        .checks { display: flex; flex-wrap: wrap; gap: 6px; }
        .check-chip {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 9px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.4;
        }
        .check-ok   { background: #d1fae5; color: #065f46; }
        .check-warn { background: #fef3c7; color: #92400e; }
        .check-info { background: #e0f2fe; color: #0369a1; }  /* real-time price */

        .check-detail {
            font-size: 11px;
            opacity: .85;
        }

        @media (max-width: 640px) {
            .navbar { padding: 14px 16px; }
            .container { padding: 0 12px; margin: 16px auto; }
            .report-header { flex-direction: column; align-items: flex-start; }
            .symbol-table th, .symbol-table td { padding: 8px 10px; }
        }
    </style>
</head>
<body>

<div class="navbar">
    <h2>Reno Robs Trading</h2>
    <div class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/trades">Trades</a>
        <a href="/analytics">Analytics</a>
        <a href="/feedback">Feedback</a>
        <a href="/validation" style="color:#1d4ed8; font-weight:700;">Validation</a>
        <a href="/account">Account</a>
        <a href="/logout">Logout ({{ user }})</a>
    </div>
</div>

<div class="container">

    <div class="header-row">
        <h1>Data Validation</h1>
        <form method="post" action="/validation/run">
            <button type="submit" class="run-btn">Run Now</button>
        </form>
    </div>

    {% if request.query_params.get('running') == '1' %}
    <div class="running-banner">
        Validation run started in the background — refresh in ~30 seconds to see results.
    </div>
    {% endif %}

    <div class="info-banner">
        Scheduled automatically: <strong>9:00 AM ET</strong> (before market open)
        and every 15 minutes from <strong>3:00–3:45 PM ET</strong> (last hour before close).
        Any difference between our scanner data and FinViz's live quote page is flagged.
    </div>

    {% if not reports %}
    <div class="no-reports">
        No validation runs yet.<br>Click <strong>Run Now</strong> to validate the current scan data.
    </div>
    {% endif %}

    {% for report in reports %}
    <div class="report-card">
        <div class="report-header">
            <span class="report-time">{{ report.run_at }}</span>
            <div class="report-summary">
                <span class="badge badge-ok">{{ report.ok_count }} OK</span>
                {% if report.warn_count > 0 %}
                <span class="badge badge-warn">{{ report.warn_count }} WARN</span>
                {% endif %}
                {% if report.error_count > 0 %}
                <span class="badge badge-err">{{ report.error_count }} ERROR</span>
                {% endif %}
                <span style="font-size:12px; color:#9ca3af;">{{ report.symbols_checked }} symbols</span>
            </div>
        </div>

        <table class="symbol-table">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Score</th>
                    <th>Status</th>
                    <th>Metric Checks</th>
                </tr>
            </thead>
            <tbody>
            {% for row in report.rows %}
            <tr>
                <td><strong>{{ row.symbol }}</strong></td>
                <td>{{ row.score }}</td>
                <td>
                    {% if row.status == 'OK' %}
                    <span class="status-ok">OK</span>
                    {% elif row.status == 'WARN' %}
                    <span class="status-warn">MISMATCH</span>
                    {% else %}
                    <span class="status-err">ERROR</span>
                    {% endif %}
                </td>
                <td>
                    {% if row.error %}
                    <span style="color:#991b1b; font-size:12px;">{{ row.error }}</span>
                    {% else %}
                    <div class="checks">
                    {% for c in row.checks %}
                        {% if c.real_time %}
                        {# Price — informational only #}
                        <span class="check-chip check-info"
                              title="Real-time price — always differs">
                            {{ c.metric }}:
                            <span class="check-detail">
                                FV={{ c.finviz }} / Ours={{ c.ours }}
                                {% if c.diff_pct is not none %}({{ c.diff_pct }}%){% endif %}
                            </span>
                        </span>
                        {% elif c.match %}
                        <span class="check-chip check-ok" title="Values match">
                            {{ c.metric }}:
                            <span class="check-detail">
                                {% if c.metric == 'Shares Outstanding' or c.metric == 'Float Shares' %}
                                    {{ "{:,}".format(c.finviz|int) if c.finviz else '—' }}
                                {% else %}
                                    {{ c.finviz }}
                                {% endif %}
                            </span>
                        </span>
                        {% else %}
                        <span class="check-chip check-warn" title="Mismatch detected">
                            {{ c.metric }}:
                            <span class="check-detail">
                                FV={% if c.metric == 'Shares Outstanding' or c.metric == 'Float Shares' %}{{ "{:,}".format(c.finviz|int) if c.finviz else '—' }}{% else %}{{ c.finviz if c.finviz is not none else '—' }}{% endif %}
                                / Ours={% if c.metric == 'Shares Outstanding' or c.metric == 'Float Shares' %}{{ "{:,}".format(c.ours|int) if c.ours else '—' }}{% else %}{{ c.ours if c.ours is not none else '—' }}{% endif %}
                                {% if c.diff_pct is not none %} ({{ c.diff_pct }}% off){% endif %}
                            </span>
                        </span>
                        {% endif %}
                    {% endfor %}
                    </div>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% endfor %}

</div>
</body>
</html>
