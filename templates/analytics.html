<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Analytics – Reno Robs Trading</title>
    <link rel="icon" type="image/png" href="/static/logo.png">

    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
            background-color: #f7f9fc;
            color: #1f2937;
        }

        .navbar {
            background: white;
            padding: 18px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .navbar h2 { margin: 0; font-weight: 600; }

        .nav-links a {
            margin-left: 20px;
            text-decoration: none;
            font-weight: 500;
            color: #4f46e5;
        }

        .logout { color: #dc2626; }

        .container {
            padding: 40px;
            max-width: 1200px;
            margin: auto;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.05);
        }

        .card h3 {
            margin: 0;
            font-size: 14px;
            color: #6b7280;
        }

        .card p {
            font-size: 28px;
            font-weight: 600;
            margin-top: 8px;
            margin-bottom: 0;
        }

        .card p.positive { color: #16a34a; }
        .card p.negative { color: #dc2626; }
        .card p.neutral  { color: #1f2937; }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 14px rgba(0,0,0,0.05);
            margin-bottom: 40px;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
        }

        th {
            background: #f3f4f6;
            font-weight: 600;
        }

        tr:not(:last-child) {
            border-bottom: 1px solid #f1f1f1;
        }

        .good { color: #16a34a; font-weight: 600; }
        .bad  { color: #dc2626; font-weight: 600; }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.05);
            margin-bottom: 40px;
        }

        .empty-note {
            color: #6b7280;
            font-size: 14px;
            padding: 20px 0;
        }

        /* ---- Mobile ---- */
        @media (max-width: 640px) {
            .navbar { padding: 10px 14px; flex-wrap: wrap; gap: 6px; }
            .navbar h2 { font-size: 14px; }
            .nav-user { display: none; }
            .nav-links { display: flex; flex-wrap: wrap; gap: 4px; width: 100%; }
            .nav-links a { margin-left: 0; padding: 5px 10px; font-size: 12px;
                           background: #f3f4f6; border-radius: 5px; }
            .nav-links .logout { background: #fee2e2; }
            .container { padding: 14px; }
            .chart-card { padding: 14px; }
            table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
            th, td { padding: 9px 10px; font-size: 12px; white-space: nowrap; }
            th:first-child, td:first-child {
                position: sticky; left: 0; z-index: 1;
                background: white; box-shadow: 2px 0 4px rgba(0,0,0,0.06);
            }
        }
    </style>
</head>

<body>

<div class="navbar">
    <div style="display:flex; align-items:center; gap:12px;">
        <img src="/static/logo.png" alt="Logo" style="height:44px; width:auto; border-radius:6px;">
        <h2 style="margin:0;">Reno Robs Trading</h2>
    </div>

    <div class="nav-links">
        <span class="nav-user" style="margin-right:20px; color:#6b7280;">
            Logged in as {{ user }}
        </span>
        <a href="/dashboard">Dashboard</a>
        <a href="/analytics">Analytics</a>
        <a href="/feedback">Feedback</a>
        <a href="/validation">Validation</a>
        <a href="/account">Account</a>
        <a href="/logout" class="logout">Logout</a>
    </div>
</div>

<div class="container">

    <h2 style="margin-bottom:30px;">Backtesting Analytics</h2>

    <!-- KPI CARDS -->
    <div class="kpi-grid">

        <div class="card">
            <h3>Avg 1-Day Return</h3>
            {% if holding_perf %}
                <p class="{{ 'positive' if holding_perf.avg_day1 > 0 else 'negative' }}">
                    {{ holding_perf.avg_day1 }}%
                </p>
            {% else %}
                <p class="neutral">—</p>
            {% endif %}
        </div>

        <div class="card">
            <h3>Avg 3-Day Return</h3>
            {% if holding_perf %}
                <p class="{{ 'positive' if holding_perf.avg_day3 > 0 else 'negative' }}">
                    {{ holding_perf.avg_day3 }}%
                </p>
            {% else %}
                <p class="neutral">—</p>
            {% endif %}
        </div>

        <div class="card">
            <h3>Total Trades Tracked</h3>
            {% set total = namespace(n=0) %}
            {% for bucket, data in score_buckets.items() %}
                {% set total.n = total.n + data.trades %}
            {% endfor %}
            <p class="neutral">{{ total.n }}</p>
        </div>

        <div class="card">
            <h3>Win Rate</h3>
            {% if risk_metrics and risk_metrics.win_rate is not none %}
                <p class="{{ 'positive' if risk_metrics.win_rate >= 50 else 'negative' }}">
                    {{ risk_metrics.win_rate }}%
                </p>
            {% else %}
                <p class="neutral">—</p>
            {% endif %}
        </div>

        <div class="card">
            <h3>Sharpe Ratio</h3>
            {% if risk_metrics and risk_metrics.sharpe is not none %}
                <p class="{{ 'positive' if risk_metrics.sharpe >= 1 else ('neutral' if risk_metrics.sharpe >= 0 else 'negative') }}">
                    {{ risk_metrics.sharpe }}
                </p>
            {% else %}
                <p class="neutral">—</p>
            {% endif %}
        </div>

        <div class="card">
            <h3>Max Drawdown</h3>
            {% if risk_metrics and risk_metrics.max_drawdown is not none %}
                <p class="{{ 'negative' if risk_metrics.max_drawdown > 10 else 'neutral' }}">
                    -{{ risk_metrics.max_drawdown }}%
                </p>
            {% else %}
                <p class="neutral">—</p>
            {% endif %}
        </div>

    </div>

    <!-- SCORE BUCKET TABLE -->
    <div class="section-title">Score Bucket Performance</div>
    <p style="color:#6b7280; font-size:13px; margin:-8px 0 16px;">
        <strong>Hit 20%+</strong> = % of setups that spiked ≥20% within 7 trading days (take-profit target).
        <strong>Avg Days</strong> = how fast it hit — lower is better (faster = stronger signal).
    </p>

    <table>
        <thead>
            <tr>
                <th>Score Bucket</th>
                <th>Trades</th>
                <th>Avg Return</th>
                <th>Any Gain %</th>
                <th style="color:#0f766e;">Hit 20%+ ★</th>
                <th style="color:#0f766e;">Avg Days to 20%+</th>
            </tr>
        </thead>
        <tbody>
        {% for bucket, data in score_buckets.items() %}
            <tr>
                <td>{{ bucket }}</td>
                <td>{{ data.trades }}</td>
                <td class="{{ 'good' if data.avg_return > 0 else 'bad' }}">
                    {% if data.trades > 0 %}{{ data.avg_return }}%{% else %}—{% endif %}
                </td>
                <td>
                    {% if data.trades > 0 %}{{ data.win_rate }}%{% else %}—{% endif %}
                </td>
                <td style="font-weight:600; color:{% if data.hit_20pct >= 30 %}#0f766e{% elif data.hit_20pct >= 15 %}#92400e{% else %}#6b7280{% endif %};">
                    {% if data.trades > 0 %}{{ data.hit_20pct }}%{% else %}—{% endif %}
                </td>
                <td style="font-weight:600; color:{% if data.avg_days_to_20pct is not none and data.avg_days_to_20pct <= 2 %}#0f766e{% elif data.avg_days_to_20pct is not none and data.avg_days_to_20pct <= 4 %}#92400e{% else %}#6b7280{% endif %};">
                    {% if data.avg_days_to_20pct is not none %}{{ data.avg_days_to_20pct }}d{% else %}—{% endif %}
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <!-- SELF-LEARNING LOOP STATUS -->
    <div class="section-title">Self-Learning Loop Status</div>
    <div class="chart-card" style="margin-bottom:40px; padding:20px 28px;">
        <div style="display:flex; flex-wrap:wrap; gap:24px; margin-bottom:16px; align-items:flex-end;">
            <div style="text-align:center; min-width:80px;">
                <div style="font-size:28px; font-weight:700; color:#1f2937;">{{ live_scan_stats.total }}</div>
                <div style="font-size:12px; color:#6b7280; margin-top:2px;">Total Scans</div>
            </div>
            <div style="text-align:center; min-width:80px;">
                <div style="font-size:28px; font-weight:700; color:#0f766e;">{{ live_scan_stats.labeled }}</div>
                <div style="font-size:12px; color:#6b7280; margin-top:2px;">Outcomes Labeled</div>
            </div>
            <div style="text-align:center; min-width:80px;">
                <div style="font-size:28px; font-weight:700; color:#d97706;">{{ live_scan_stats.pending }}</div>
                <div style="font-size:12px; color:#6b7280; margin-top:2px;">Pending (&lt;2 days)</div>
            </div>
            {% if live_scan_stats.awaiting > 0 %}
            <div style="text-align:center; min-width:80px;">
                <div style="font-size:28px; font-weight:700; color:#9333ea;">{{ live_scan_stats.awaiting }}</div>
                <div style="font-size:12px; color:#6b7280; margin-top:2px;">Ready to Label</div>
            </div>
            {% endif %}
            {% if live_scan_stats.labeled > 0 %}
            <div style="text-align:center; min-width:80px; border-left:1px solid #f3f4f6; padding-left:24px;">
                <div style="font-size:28px; font-weight:700; color:{{ '#0f766e' if live_scan_stats.hit_rate >= 30 else '#6b7280' }};">
                    {{ live_scan_stats.hit_rate }}%
                </div>
                <div style="font-size:12px; color:#6b7280; margin-top:2px;">Hit +20% Target</div>
            </div>
            {% if live_scan_stats.avg_days_to_20 %}
            <div style="text-align:center; min-width:80px;">
                <div style="font-size:28px; font-weight:700; color:#0f766e;">{{ live_scan_stats.avg_days_to_20 }}d</div>
                <div style="font-size:12px; color:#6b7280; margin-top:2px;">Avg Days to +20%</div>
            </div>
            {% endif %}
            {% endif %}
        </div>
        <div style="font-size:12px; color:#9ca3af; border-top:1px solid #f3f4f6; padding-top:12px; line-height:1.6;">
            Outcomes tracked over <strong>10 trading days (2 weeks)</strong> from scan date.
            Hypothesis + weights auto-update each morning when new outcomes are labeled.
            {% if live_scan_stats.last_auto_learn %}
            Last auto-learn: <strong>{{ live_scan_stats.last_auto_learn[:16] }} UTC</strong>
            {% else %}
            Auto-learn not yet run — needs 5+ labeled scans.
            {% endif %}
        </div>

        <!-- LSTM Model status -->
        <div style="margin-top:16px; padding-top:16px; border-top:1px solid #f3f4f6; display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
            <div style="font-size:12px; color:#6b7280; font-weight:600; text-transform:uppercase; letter-spacing:0.05em;">LSTM Model</div>
            {% if lstm_status and lstm_status.trained %}
            <span style="font-size:13px; color:#0f766e; font-weight:600;">&#10003; Trained</span>
            <span style="font-size:12px; color:#9ca3af;">{{ lstm_status.accuracy }}% val accuracy &middot; {{ lstm_status.samples }} training samples &middot; {{ lstm_status.trained_at }}</span>
            {% else %}
            <span style="font-size:12px; color:#9ca3af;">Not trained — run Historical Training Data to train the LSTM</span>
            {% endif %}
        </div>
    </div>

    <!-- CURRENT HYPOTHESIS -->
    <div class="section-title" style="color:#7c3aed;">Current AI Hypothesis</div>

    <div class="chart-card" style="margin-bottom:40px; border-left:4px solid #7c3aed;">
        <p style="color:#6b7280; font-size:14px; margin-top:0; margin-bottom:16px;">
            The synthesized hypothesis below is the <strong>primary driver</strong> of scoring
            weight adjustments. When you run the optimizer, it reads this hypothesis and translates
            the identified patterns into concrete weight changes and new metric suggestions.
            Generate or update it on the <a href="/feedback" style="color:#7c3aed;">Feedback page</a>.
        </p>

        {% if hypothesis %}
        <div style="margin-bottom:10px; font-size:12px; color:#9ca3af;">
            Generated {{ hypothesis.updated_at[:10] }} &nbsp;·&nbsp;
            {{ hypothesis.source_count }} source{{ 's' if hypothesis.source_count != 1 else '' }}
        </div>
        <div style="background:#faf5ff; border:1px solid #e9d5ff; border-radius:8px;
                    padding:16px 18px; font-size:13px; line-height:1.7;
                    white-space:pre-wrap; max-height:420px; overflow-y:auto;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
            {{ hypothesis.content }}
        </div>
        {% else %}
        <p style="color:#6b7280; font-size:14px;">
            No hypothesis generated yet. Submit winning trades on the
            <a href="/feedback" style="color:#7c3aed;">Feedback page</a>
            and click "Sync All Sources" to generate one.
        </p>
        {% endif %}
    </div>

    <!-- COMPLEX + AI MODE LIVE OPTIMIZER -->
    <div class="section-title" style="color: #0f766e;">Complex + AI Mode — Live Weight Optimizer</div>

    <div class="chart-card" style="margin-bottom:40px; border-left: 4px solid #0f766e;">
        <p style="color:#6b7280; font-size:14px; margin-top:0; margin-bottom:16px;">
            Analyzes backtesting data <strong>and</strong> your feedback submissions to continuously
            refine scoring weights. <strong>Objective: maximize the rate of 20%+ next-day spikes.</strong>
            Weights auto-update on each feedback submission. Requires 5+ scans with known returns.
        </p>

        {% if complex_ai_weights %}
        <div style="margin-bottom:20px; background:#f0fdf4; border:1px solid #86efac;
                    border-radius:8px; padding:16px 18px;">
            <div style="font-weight:700; color:#166534; margin-bottom:10px; font-size:14px;">
                Active Weights &nbsp;·&nbsp;
                <span style="font-weight:400; font-size:12px; color:#6b7280;">
                    Last updated {{ complex_ai_weights.updated_at[:10] }}
                </span>
            </div>

            <!-- Weight grid -->
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(210px,1fr));
                        gap:6px 20px; font-size:13px; margin-bottom:12px;">
                {% set w = complex_ai_weights.weights %}
                <div><strong>Rel. Vol ≥50x:</strong> {{ w.rel_vol_50x }}</div>
                <div><strong>Rel. Vol ≥25x:</strong> {{ w.rel_vol_25x }}</div>
                <div><strong>Rel. Vol ≥10x:</strong> {{ w.rel_vol_10x }}</div>
                <div><strong>Rel. Vol ≥5x:</strong> {{ w.rel_vol_5x }}</div>
                <div><strong>Daily 20–40% (sweet spot):</strong> {{ w.daily_sweet_20_40 }}</div>
                <div><strong>Daily 10–20%:</strong> {{ w.daily_ok_10_20 }}</div>
                <div><strong>Daily 40–100%:</strong> {{ w.daily_ok_40_100 }}</div>
                <div><strong>Sideways Consolidation:</strong> {{ w.sideways_chop }}</div>
                <div><strong>Yesterday Green:</strong> {{ w.yesterday_green }}</div>
                <div><strong>Shares &lt;10M:</strong> {{ w.shares_lt10m }}</div>
                <div><strong>Shares 10–30M:</strong> {{ w.shares_lt30m }}</div>
                <div><strong>Shares 30–100M:</strong> {{ w.shares_lt100m }}</div>
                <div><strong>No News (organic):</strong> {{ w.no_news_bonus }}</div>
                <div><strong>High Cash/Share:</strong> {{ w.high_cash_bonus }}</div>
                <div><strong>Institution ≥20%:</strong> {{ w.institution_moderate }}</div>
                <div><strong>Institution ≥50%:</strong> {{ w.institution_strong }}</div>
            </div>

            {% if complex_ai_weights.rationale %}
            <div style="font-size:13px; color:#374151; line-height:1.6;
                        border-top:1px solid #bbf7d0; padding-top:10px; margin-top:4px;">
                {{ complex_ai_weights.rationale }}
            </div>
            {% endif %}

            {% if complex_ai_weights.suggestions %}
            <div style="margin-top:12px; font-size:13px;">
                <strong style="color:#166534;">Suggested new signals to track:</strong>
                <ul style="margin:6px 0 0 16px; color:#374151; line-height:1.7;">
                    {% for s in complex_ai_weights.suggestions %}
                    <li>{{ s }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <form method="post" action="/optimize-complex">
            <button type="submit" style="background:#0f766e; color:white; border:none;
                    padding:10px 22px; border-radius:8px; cursor:pointer;
                    font-size:14px; font-weight:600;">
                Re-optimize Now
            </button>
        </form>

        {% if complex_ai_result %}
        <div style="margin-top:20px; padding:16px 18px; background:#f0fdf4;
                    border-radius:8px; border:1px solid #86efac;">
            <div style="font-weight:600; color:#166534; margin-bottom:8px;">
                Optimization Complete
            </div>
            {% if complex_ai_result.summary %}
            <div style="font-size:13px; color:#1f2937; margin-bottom:8px;">
                {{ complex_ai_result.summary }}
            </div>
            {% endif %}
            {% if complex_ai_result.rationale %}
            <div style="font-size:13px; color:#374151; line-height:1.65;">
                {{ complex_ai_result.rationale }}
            </div>
            {% endif %}
            {% if complex_ai_result.get('error') %}
            <div style="font-size:12px; color:#dc2626; margin-top:8px;">
                Note: {{ complex_ai_result.error }}. Previous weights retained.
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- COMPLEX + AI CHANGE LOG -->
    <div class="section-title" style="color:#0f766e;">Complex + AI Model — Change Log</div>

    <div class="chart-card" style="margin-bottom:40px; border-left:4px solid #0f766e;">
        {% if weight_changelog %}
        <table style="margin-bottom:0;">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Summary</th>
                    <th>Rationale</th>
                </tr>
            </thead>
            <tbody>
            {% for entry in weight_changelog %}
                <tr>
                    <td style="white-space:nowrap; font-size:13px; color:#6b7280;">
                        {{ entry.updated_at[:16].replace("T", " ") }}
                    </td>
                    <td style="font-size:13px; font-weight:600; color:#1f2937;">
                        {{ entry.summary or "—" }}
                    </td>
                    <td style="font-size:12px; color:#4b5563; line-height:1.5;">
                        {{ entry.rationale or "—" }}
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty-note">
            No model updates logged yet. Use "Apply to Complex + AI Model" on the Feedback page
            or click "Re-optimize Now" above to log the first entry.
        </p>
        {% endif %}
    </div>

    <!-- WEIGHT OPTIMIZER -->
    <div class="section-title">General AI Weight Optimizer (Read-Only Recommendations)</div>

    <div class="chart-card" style="margin-bottom:40px;">
        <p style="color:#6b7280; font-size:14px; margin-top:0; margin-bottom:16px;">
            Analyzes your backtesting data and recommends scoring weight adjustments
            to maximize the <strong>20%+ next-day spike rate</strong> — the take-profit target.
            Also suggests new criteria to track. Requires 5+ scans with known returns.
        </p>

        <form method="post" action="/optimize">
            <button type="submit" style="background:#4f46e5; color:white; border:none;
                    padding:10px 22px; border-radius:8px; cursor:pointer;
                    font-size:14px; font-weight:600;">
                Run Optimizer
            </button>
        </form>

        {% if weight_analysis %}
        <div style="margin-top:24px; padding:20px; background:#f8f9ff;
                    border-radius:8px; border:1px solid #e0e7ff;">
            <div style="font-size:13px; line-height:1.7; white-space:pre-wrap;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">
                {{ weight_analysis }}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- HISTORICAL TRAINING DATA -->
    <div class="section-title" style="color:#7c3aed;">Historical Training Data</div>

    <div class="chart-card" style="margin-bottom:40px; border-left:4px solid #7c3aed;">
        <p style="color:#6b7280; font-size:14px; margin-top:0; margin-bottom:16px;">
            Scans 2 years of OHLCV data for known momentum tickers plus every symbol
            you've already scanned. Finds days matching live criteria (price&nbsp;&lt;&nbsp;$5,
            daily gain 10–100%, relative volume&nbsp;≥&nbsp;10) and records the next-day return
            as a labeled example. These are automatically included in optimizer data.
        </p>

        {% if historical_count > 0 %}
        <div style="margin-bottom:16px; padding:12px 16px; background:#f5f3ff;
                    border-radius:8px; border:1px solid #c4b5fd; font-size:14px;">
            <strong style="color:#6d28d9;">{{ historical_count }}</strong>
            historical labeled examples in the training set.
        </div>
        {% endif %}

        <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
            <form method="post" action="/backfill-history">
                <button type="submit"
                        style="background:#7c3aed; color:white; border:none;
                               padding:10px 22px; border-radius:8px; cursor:pointer;
                               font-size:14px; font-weight:600;">
                    {% if backfill_status.status == 'running' %}
                        Running… ({{ backfill_status.processed }}/{{ backfill_status.total }})
                    {% else %}
                        Generate Historical Training Data
                    {% endif %}
                </button>
            </form>

            <div id="backfillStatus" style="font-size:13px; color:#6b7280;">
                {% if backfill_status.status == 'running' %}
                    Processing {{ backfill_status.processed }}/{{ backfill_status.total }} tickers
                    &nbsp;·&nbsp; {{ backfill_status.saved }} examples found so far…
                {% elif backfill_status.status == 'complete' %}
                    Last run: {{ backfill_status.saved }} examples saved from
                    {{ backfill_status.total }} tickers.
                {% endif %}
            </div>
        </div>
    </div>

    <!-- EQUITY CURVE -->
    <div class="section-title">Equity Curve (compounded, $10k start)</div>

    <div class="chart-card">
        {% if equity_curve %}
            <canvas id="equityChart" height="80"></canvas>
        {% else %}
            <p class="empty-note">
                No return data yet. Returns are filled in automatically once scans are 3+ trading days old.
            </p>
        {% endif %}
    </div>

</div>

{% if equity_curve %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const equityData = {{ equity_curve | tojson }};

new Chart(document.getElementById('equityChart'), {
    type: 'line',
    data: {
        labels: equityData.map((_, i) => 'Trade ' + (i + 1)),
        datasets: [{
            label: 'Portfolio Value ($)',
            data: equityData,
            borderColor: '#4f46e5',
            backgroundColor: 'rgba(79,70,229,0.08)',
            borderWidth: 2,
            tension: 0.3,
            fill: true,
            pointRadius: equityData.length > 50 ? 0 : 3
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: {
                beginAtZero: false,
                ticks: {
                    callback: v => '$' + v.toLocaleString()
                }
            }
        }
    }
});
</script>
{% endif %}

{% if backfill_status.status == 'running' %}
<script>
(function pollBackfill() {
    const el = document.getElementById('backfillStatus');
    if (!el) return;
    setTimeout(function tick() {
        fetch('/api/backfill-status')
            .then(r => r.json())
            .then(data => {
                if (data.status === 'running') {
                    el.textContent =
                        'Processing ' + data.processed + '/' + data.total +
                        ' tickers · ' + data.saved + ' examples found so far…';
                    setTimeout(tick, 4000);
                } else if (data.status === 'complete') {
                    el.textContent =
                        'Done! ' + data.saved + ' examples saved. AI hypothesis + weights updated automatically. Reload to see results.';
                }
            })
            .catch(() => setTimeout(tick, 8000));
    }, 4000);
})();
</script>
{% endif %}

</body>
</html>
